<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nota Bermasalah | Ali Akatiri System</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <link rel="stylesheet" href="dashboard.css">
    <style>
        .border-danger-custom { border-left: 5px solid #ef4444 !important; }
        .text-danger-custom { color: #ef4444 !important; }
        .btn-danger-save { background-color: #ef4444; border: none; color: white; font-weight: bold; }
        .btn-danger-save:hover { background-color: #dc2626; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3); }
    </style>
</head>
<body class="enterprise-bg">

    <nav class="navbar navbar-dark shadow-sm mb-4">
        <div class="container d-flex justify-content-between align-items-center">
            <span class="navbar-brand fw-bold">
                <i class="fas fa-exclamation-triangle me-2 text-warning"></i> DATABASE NOTA BERMASALAH
            </span>
            
            <div class="d-flex align-items-center gap-2">
                <a href="dashboard.html" class="btn btn-light btn-sm fw-bold px-3 shadow-sm">
                    <i class="fas fa-home me-1"></i> DASHBOARD
                </a>
                <button onclick="logout()" class="btn btn-outline-light btn-sm fw-bold px-3 rounded-pill ms-2">
                    LOGOUT
                </button>
            </div>
        </div>
    </nav>

    <div class="container mb-5">
        
        <div class="card border-0 shadow-sm mb-4 overflow-hidden border-danger-custom">
            <div class="card-header bg-white border-bottom py-3">
                <h6 class="fw-bold mb-0 text-danger-custom"><i class="fas fa-plus-circle me-2"></i>INPUT TEMUAN NOTA BERMASALAH</h6>
            </div>
            <div class="card-body p-4">
                <form id="formMasalah">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="small fw-bold text-muted">TANGGAL PADA NOTA</label>
                            <input type="date" id="tglNotaBermasalah" class="form-control border-danger" required>
                        </div>
                        <div class="col-md-6">
                            <label class="small fw-bold text-muted">DESKRIPSI KESALAHAN / MASALAH</label>
                            <input type="text" id="descMasalah" class="form-control border-danger" placeholder="Contoh: Nota #102 salah input QTY, harusnya 5 tertulis 50" required>
                        </div>
                        <div class="col-md-3">
                            <label class="small fw-bold text-muted">UNGGAH BUKTI FOTO</label>
                            <input type="file" id="fotoMasalah" class="form-control border-danger">
                        </div>
                        <div class="col-12 mt-3 text-end">
                            <button type="submit" class="btn btn-danger-save px-5 py-2">
                                <i class="fas fa-save me-2"></i> SIMPAN KE DAFTAR MASALAH
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="card border-0 shadow-sm p-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h6 class="fw-bold mb-0 text-primary"><i class="fas fa-history me-2"></i>DAFTAR NOTA BERMASALAH</h6>
                <div class="small fw-bold text-muted">TOTAL: <span id="countMasalah" class="text-danger">0</span> LAPORAN</div>
            </div>

            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr class="text-center small text-uppercase">
                            <th width="50">No</th>
                            <th>Tanggal Nota</th>
                            <th>Tanggal Input</th>
                            <th class="text-start">Deskripsi Masalah</th>
                            <th>Pelapor</th>
                            <th>Foto</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="bodyTabelMasalah" class="text-center">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="text-center pb-5">
        <small class="text-muted">Â© 2026 Ali Akatiri System - Laporan Masalah v1.0</small>
    </div>

    <script>
        // Ambil Data User dari Session
        const userAktif = sessionStorage.getItem('userName') || "Admin";

        // 1. FUNGSI RENDER TABEL
        function tampilkanData() {
            const tableBody = document.getElementById('bodyTabelMasalah');
            const dataMasalah = JSON.parse(localStorage.getItem('dataMasalah')) || [];
            const countDisplay = document.getElementById('countMasalah');

            tableBody.innerHTML = '';
            countDisplay.innerText = dataMasalah.length;

            if (dataMasalah.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="py-5 text-muted small">Belum ada laporan nota bermasalah.</td></tr>';
                return;
            }

            // Render Terbalik (Terbaru di atas)
            [...dataMasalah].reverse().forEach((item, index) => {
                const row = `
                    <tr>
                        <td>${index + 1}</td>
                        <td><span class="tgl-nota-badge">${formatTgl(item.tglNota)}</span></td>
                        <td><span class="tgl-input-badge">Input: ${formatTgl(item.tglInput)}</span></td>
                        <td class="text-start small" style="max-width: 300px;">${item.deskripsi}</td>
                        <td><span class="badge bg-light text-primary border">${item.pelapor}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-info" onclick="lihatFoto()">
                                <i class="fas fa-image"></i>
                            </button>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-link text-danger p-0" onclick="hapusMasalah(${item.id})">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tableBody.insertAdjacentHTML('beforeend', row);
            });
        }

        // 2. LOGIKA SIMPAN DATA
        document.getElementById('formMasalah').addEventListener('submit', function(e) {
            e.preventDefault();

            const tglNota = document.getElementById('tglNotaBermasalah').value;
            const desc = document.getElementById('descMasalah').value;
            const tglSistem = new Date().toISOString().split('T')[0];

            const dataBaru = {
                id: Date.now(),
                tglNota: tglNota,
                tglInput: tglSistem,
                deskripsi: desc,
                pelapor: userAktif
            };

            let database = JSON.parse(localStorage.getItem('dataMasalah')) || [];
            database.push(dataBaru);
            localStorage.setItem('dataMasalah', JSON.stringify(database));

            Swal.fire({
                icon: 'success',
                title: 'Masalah Dicatat',
                timer: 1500,
                showConfirmButton: false
            });

            this.reset();
            tampilkanData();
        });

        // 3. FUNGSI PENDUKUNG
        function formatTgl(str) {
            if(!str) return "-";
            return new Date(str).toLocaleDateString('id-ID', { day: 'numeric', month: 'short' });
        }

        function hapusMasalah(id) {
            Swal.fire({
                title: 'Hapus Laporan?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                confirmButtonText: 'Ya, Hapus'
            }).then((result) => {
                if (result.isConfirmed) {
                    let db = JSON.parse(localStorage.getItem('dataMasalah'));
                    db = db.filter(x => x.id !== id);
                    localStorage.setItem('dataMasalah', JSON.stringify(db));
                    tampilkanData();
                }
            });
        }

        function lihatFoto() {
            Swal.fire({
                title: 'Bukti Foto',
                imageUrl: 'https://via.placeholder.com/400x300?text=Preview+Foto+Nota',
                imageAlt: 'Bukti Nota'
            });
        }

        function logout() {
            sessionStorage.clear();
            window.location.href = 'index.html';
        }

        // Jalankan saat load
        document.addEventListener('DOMContentLoaded', tampilkanData);
    </script>
</body>
</html>
