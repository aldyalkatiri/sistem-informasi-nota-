<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Sistem Informasi Nota Ali Akatiri</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { background-color: #f1f5f9; font-family: sans-serif; }
        .navbar { background: linear-gradient(90deg, #0f172a 0%, #1e293b 100%) !important; border-bottom: 3px solid #3b82f6; }
        .stat-card-total { background: linear-gradient(135deg, #6366f1 0%, #4338ca 100%); color: white; border: none; }
        .stat-card-pagi { background: white; border-bottom: 5px solid #0ea5e9; border-top: none; border-left: none; border-right: none; }
        .stat-card-malam { background: #1e293b; color: white; border: none; }
        .stat-card-qty { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; }
        .header-panel { background-color: #f8fafc; border-bottom: 2px solid #e2e8f0; padding: 15px; border-radius: 15px 15px 0 0; }
        .card { border-radius: 15px; }
        @media print { .navbar, #adminPanel, .action-col, #cariData, .btn-success, footer { display: none !important; } }
    </style>
</head>
<body>

<nav class="navbar navbar-dark shadow-sm">
    <div class="container d-flex justify-content-between align-items-center">
        <span class="navbar-brand fw-bold"><i class="fas fa-database me-2 text-info"></i> SISTEM NOTA</span>
        <button id="btnLogout" class="btn btn-danger btn-sm px-4 fw-bold rounded-pill">LOGOUT</button>
    </div>
</nav>

<div class="container my-5">
    <div class="row mb-4 text-center">
        <div class="col-md-3 mb-3"><div class="card stat-card-total p-4 shadow-sm"><small>TOTAL NOTA</small><h2 id="statTotal">0</h2></div></div>
        <div class="col-md-3 mb-3"><div class="card stat-card-pagi p-4 shadow-sm"><small class="text-primary">SHIFT PAGI</small><h2 id="statPagi" class="text-primary">0</h2></div></div>
        <div class="col-md-3 mb-3"><div class="card stat-card-malam p-4 shadow-sm"><small>SHIFT MALAM</small><h2 id="statMalam">0</h2></div></div>
        <div class="col-md-3 mb-3"><div class="card stat-card-qty p-4 shadow-sm"><small>TOTAL UNIT</small><h2 id="statTotalQty">0</h2></div></div>
    </div>

    <div id="adminPanel" class="card mb-5 border-0 shadow">
        <div class="header-panel text-center"><h5 class="fw-bold mb-0">INPUT DATA NOTA BARU</h5></div>
        <div class="card-body p-4">
            <form id="notaForm">
                <div class="row g-3">
                    <div class="col-md-3"><label class="form-label small fw-bold">TANGGAL</label><input type="date" id="tanggalNota" class="form-control" required></div>
                    <div class="col-md-3"><label class="form-label small fw-bold">JENIS</label>
                        <select id="kodeJenis" class="form-select" required>
                            <option value="SL">SL (BAN)</option><option value="SD">SD (LAS)</option><option value="SI">SI (MEKANIK PERAWATAN)</option>
                            <option value="SX">SX (MEKANIK)</option><option value="SY">SY (GRASSES)</option><option value="SG">SG (ELEKTRIK)</option>
                            <option value="ST">ST (PERAWATAN ALAT BERAT)</option>
                        </select>
                    </div>
                    <div class="col-md-3"><label class="form-label small fw-bold">SHIFT</label><select id="shift" class="form-select"><option value="PAGI">PAGI</option><option value="MALAM">MALAM</option></select></div>
                    <div class="col-md-3"><label class="form-label small fw-bold">QTY</label><input type="number" id="jumlah" class="form-control" required min="1"></div>
                </div>
                <button type="submit" class="btn btn-primary w-100 mt-4 fw-bold"><i class="fas fa-save me-2"></i>SIMPAN KE CLOUD</button>
            </form>
        </div>
    </div>

    <div class="card border-0 shadow-lg">
        <div class="card-body p-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="fw-bold mb-0">Rincian Data Real-time</h5>
                <input type="text" id="cariData" class="form-control form-control-sm w-25" placeholder="Cari...">
            </div>
            <div class="table-responsive">
                <table class="table table-hover text-center" id="tableToExport">
                    <thead><tr class="table-light"><th>No</th><th>Tanggal</th><th>Kode</th><th class="text-start">Deskripsi</th><th>Shift</th><th>Qty</th><th class="action-col">Aksi</th></tr></thead>
                    <tbody id="tabelNota"></tbody>
                </table>
            </div>
        </div>
    </div>
    <footer class="text-center mt-5 pb-4"><p class="text-muted small">Powered by Ali Akatiri | 2026</p></footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, set, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCM3YRUd51lT2wFSOESJH-ZjvQQJeUJMUw",
        authDomain: "sistem-nota.firebaseapp.com",
        databaseURL: "https://sistem-nota-default-rtdb.firebaseio.com",
        projectId: "sistem-nota",
        storageBucket: "sistem-nota.firebasestorage.app",
        messagingSenderId: "1043542152932",
        appId: "1:1043542152932:web:21d4bc67f185fb4768fef1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const dbRef = ref(db, 'nota_data');

    const deskripsiMap = { "SL": "BAN", "SD": "LAS", "SI": "MEKANIK PERAWATAN", "SX": "MEKANIK", "SY": "GRASSES", "SG": "ELEKTRIK", "ST": "PERAWATAN ALAT BERAT" };

    // Simpan Data
    document.getElementById('notaForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const kode = document.getElementById('kodeJenis').value;
        const data = {
            tanggal: document.getElementById('tanggalNota').value,
            kode: kode,
            deskripsi: deskripsiMap[kode],
            shift: document.getElementById('shift').value,
            qty: parseInt(document.getElementById('jumlah').value)
        };
        push(dbRef, data).then(() => {
            Swal.fire('Berhasil!', 'Data tersimpan', 'success');
            document.getElementById('notaForm').reset();
        });
    });

    // Tampilkan Data Real-time
    onValue(dbRef, (snapshot) => {
        const data = snapshot.val();
        const tbody = document.getElementById('tabelNota');
        tbody.innerHTML = "";
        let totalNota = 0, pagi = 0, malam = 0, totalQty = 0;

        if (data) {
            Object.keys(data).reverse().forEach((key, index) => {
                const item = data[key];
                totalNota++; totalQty += item.qty;
                item.shift === "PAGI" ? pagi++ : malam++;
                tbody.innerHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${item.tanggal}</td>
                        <td><span class="badge bg-secondary">${item.kode}</span></td>
                        <td class="text-start">${item.deskripsi}</td>
                        <td><span class="badge ${item.shift === 'PAGI' ? 'bg-info' : 'bg-dark'}">${item.shift}</span></td>
                        <td class="fw-bold">${item.qty}</td>
                        <td class="action-col"><button class="btn btn-sm text-danger btn-hapus" data-id="${key}"><i class="fas fa-trash"></i></button></td>
                    </tr>`;
            });
            document.querySelectorAll('.btn-hapus').forEach(btn => {
                btn.onclick = () => {
                    const id = btn.getAttribute('data-id');
                    Swal.fire({ title: 'Hapus?', icon: 'warning', showCancelButton: true }).then(r => {
                        if(r.isConfirmed) remove(ref(db, 'nota_data/' + id));
                    });
                };
            });
        }
        document.getElementById('statTotal').innerText = totalNota;
        document.getElementById('statPagi').innerText = pagi;
        document.getElementById('statMalam').innerText = malam;
        document.getElementById('statTotalQty').innerText = totalQty;
    });

    document.getElementById('btnLogout').onclick = () => window.location.href = 'index.html';
</script>
</body>
</html>
